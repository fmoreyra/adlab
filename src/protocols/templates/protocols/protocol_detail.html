{% extends "layouts/index.html" %}
{% load static %}

{% block title %}Protocolo {{ protocol.protocol_number|default:protocol.temporary_code|default:"Detalles" }} - Sistema de Laboratorio{% endblock %}

{% block body %}
<div class="min-h-screen bg-gray-50 py-8">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="mb-8">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-3xl font-bold text-gray-900">
                        Protocolo: {% if protocol.protocol_number %}{{ protocol.protocol_number }}{% elif protocol.temporary_code %}{{ protocol.temporary_code }}{% else %}#{{ protocol.id }}{% endif %}
                    </h1>
                    <p class="mt-2 text-sm text-gray-600">
                        {{ protocol.get_analysis_type_display }} - Creado el {{ protocol.created_at|date:"d" }} de {{ protocol.created_at|date:"F" }} de {{ protocol.created_at|date:"Y" }}
                    </p>
                </div>
                <div class="flex gap-2">
                    {% if protocol.is_editable %}
                        <a href="{% url 'protocols:protocol_edit' protocol.pk %}" 
                           class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                            Editar
                        </a>
                    {% endif %}
                    {% if protocol.status == 'draft' %}
                        <form method="post" action="{% url 'protocols:protocol_submit' protocol.pk %}" class="inline">
                            {% csrf_token %}
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                Enviar Protocolo
                            </button>
                        </form>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Main Content -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Status Card -->
                <div class="bg-white shadow-md rounded-lg p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4">Estado</h2>
                    <div class="flex items-center gap-4">
                        <span class="px-4 py-2 rounded-full text-sm font-semibold
                                     {% if protocol.status == 'draft' %}bg-gray-100 text-gray-800
                                     {% elif protocol.status == 'submitted' %}bg-yellow-100 text-yellow-800
                                     {% elif protocol.status == 'received' %}bg-blue-100 text-blue-800
                                     {% elif protocol.status == 'processing' %}bg-purple-100 text-purple-800
                                     {% elif protocol.status == 'ready' %}bg-green-100 text-green-800
                                     {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ protocol.get_status_display }}
                        </span>
                        {% if protocol.temporary_code %}
                            <div class="text-sm text-gray-600">
                                <strong>Código Temporal:</strong> {{ protocol.temporary_code }}
                            </div>
                        {% endif %}
                    </div>
                </div>

                <!-- Animal Information Card -->
                <div class="bg-white shadow-md rounded-lg p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 border-b pb-2">Información del Animal</h2>
                    <dl class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Especie</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ protocol.species }}</dd>
                        </div>
                        {% if protocol.breed %}
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Raza</dt>
                                <dd class="mt-1 text-sm text-gray-900">{{ protocol.breed }}</dd>
                            </div>
                        {% endif %}
                        {% if protocol.sex %}
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Sexo</dt>
                                <dd class="mt-1 text-sm text-gray-900">{{ protocol.get_sex_display }}</dd>
                            </div>
                        {% endif %}
                        {% if protocol.age %}
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Edad</dt>
                                <dd class="mt-1 text-sm text-gray-900">{{ protocol.age }}</dd>
                            </div>
                        {% endif %}
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Identificación</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ protocol.animal_identification }}</dd>
                        </div>
                        {% if protocol.get_owner_full_name %}
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Propietario</dt>
                                <dd class="mt-1 text-sm text-gray-900">{{ protocol.get_owner_full_name }}</dd>
                            </div>
                        {% endif %}
                    </dl>
                </div>

                <!-- Clinical Information Card -->
                <div class="bg-white shadow-md rounded-lg p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 border-b pb-2">Información Clínica</h2>
                    <dl class="space-y-4">
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Diagnóstico Presuntivo</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ protocol.presumptive_diagnosis }}</dd>
                        </div>
                        {% if protocol.clinical_history %}
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Historia Clínica</dt>
                                <dd class="mt-1 text-sm text-gray-900 whitespace-pre-wrap">{{ protocol.clinical_history }}</dd>
                            </div>
                        {% endif %}
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Interés Académico</dt>
                            <dd class="mt-1 text-sm text-gray-900">
                                {% if protocol.academic_interest %}
                                    <span class="text-green-600">✓ Sí</span>
                                {% else %}
                                    <span class="text-gray-400">✗ No</span>
                                {% endif %}
                            </dd>
                        </div>
                    </dl>
                </div>

                <!-- Sample Information Card -->
                {% if sample %}
                    <div class="bg-white shadow-md rounded-lg p-6">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4 border-b pb-2">Información de la Muestra</h2>
                        <dl class="space-y-4">
                            {% if protocol.analysis_type == 'cytology' %}
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Técnica Utilizada</dt>
                                    <dd class="mt-1 text-sm text-gray-900">{{ sample.technique_used }}</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Sitio de Muestreo</dt>
                                    <dd class="mt-1 text-sm text-gray-900">{{ sample.sampling_site }}</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Número de Portaobjetos</dt>
                                    <dd class="mt-1 text-sm text-gray-900">{{ sample.number_of_slides }}</dd>
                                </div>
                            {% else %}
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Material Remitido</dt>
                                    <dd class="mt-1 text-sm text-gray-900 whitespace-pre-wrap">{{ sample.material_submitted }}</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Número de Frascos</dt>
                                    <dd class="mt-1 text-sm text-gray-900">{{ sample.number_of_containers }}</dd>
                                </div>
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Conservación</dt>
                                    <dd class="mt-1 text-sm text-gray-900">{{ sample.preservation }}</dd>
                                </div>
                            {% endif %}
                            {% if sample.observations %}
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Observaciones</dt>
                                    <dd class="mt-1 text-sm text-gray-900 whitespace-pre-wrap">{{ sample.observations }}</dd>
                                </div>
                            {% endif %}
                        </dl>
                    </div>
                {% endif %}

                <!-- Discrepancies Card (only show if there are discrepancies) -->
                {% if protocol.discrepancies %}
                    <div class="bg-white shadow-md rounded-lg p-6 border-l-4 border-orange-400">
                        <h2 class="text-lg font-semibold text-gray-900 mb-4 border-b pb-2 flex items-center">
                            <svg class="h-5 w-5 text-orange-500 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                            </svg>
                            Discrepancias Encontradas
                        </h2>
                        <div class="bg-orange-50 border border-orange-200 rounded-md p-4">
                            <div class="flex">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-orange-400" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <h3 class="text-sm font-medium text-orange-800">
                                        Se encontraron discrepancias durante la recepción
                                    </h3>
                                    <div class="mt-2 text-sm text-orange-700">
                                        <p class="whitespace-pre-wrap">{{ protocol.discrepancies }}</p>
                                    </div>
                                    {% if protocol.sample_condition %}
                                        <div class="mt-3">
                                            <span class="text-sm font-medium text-orange-800">Condición de la muestra:</span>
                                            <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                                {% if protocol.sample_condition == 'optimal' %}bg-green-100 text-green-800
                                                {% elif protocol.sample_condition == 'acceptable' %}bg-yellow-100 text-yellow-800
                                                {% elif protocol.sample_condition == 'suboptimal' %}bg-orange-100 text-orange-800
                                                {% elif protocol.sample_condition == 'rejected' %}bg-red-100 text-red-800
                                                {% else %}bg-gray-100 text-gray-800{% endif %}">
                                                {{ protocol.get_sample_condition_display }}
                                            </span>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>

            <!-- Sidebar -->
            <div class="space-y-6">
                <!-- Dates Card -->
                <div class="bg-white shadow-md rounded-lg p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 border-b pb-2">Fechas Importantes</h2>
                    <dl class="space-y-3">
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Fecha de Remisión</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ protocol.submission_date|date:"d" }} de {{ protocol.submission_date|date:"F" }} de {{ protocol.submission_date|date:"Y" }}</dd>
                        </div>
                        {% if protocol.reception_date %}
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Fecha de Recepción</dt>
                                <dd class="mt-1 text-sm text-gray-900">{{ protocol.reception_date|date:"d" }} de {{ protocol.reception_date|date:"F" }} de {{ protocol.reception_date|date:"Y" }}</dd>
                            </div>
                        {% endif %}
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Creado</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ protocol.created_at|date:"d" }} de {{ protocol.created_at|date:"F" }} de {{ protocol.created_at|date:"Y" }}, {{ protocol.created_at|date:"H:i" }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Última Actualización</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ protocol.updated_at|date:"d" }} de {{ protocol.updated_at|date:"F" }} de {{ protocol.updated_at|date:"Y" }}, {{ protocol.updated_at|date:"H:i" }}</dd>
                        </div>
                    </dl>
                </div>

                <!-- Veterinarian Information Card -->
                <div class="bg-white shadow-md rounded-lg p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 border-b pb-2">Información del Veterinario</h2>
                    <dl class="space-y-3">
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Nombre</dt>
                            <dd class="mt-1 text-sm text-gray-900">{{ protocol.veterinarian.get_full_name }}</dd>
                        </div>
                        <div>
                            <dt class="text-sm font-medium text-gray-500">Matrícula</dt>
                            <dd class="mt-1 text-sm text-gray-900 font-mono">{{ protocol.veterinarian.license_number }}</dd>
                        </div>
                        {% if protocol.veterinarian.phone %}
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Teléfono</dt>
                                <dd class="mt-1 text-sm text-gray-900">{{ protocol.veterinarian.phone }}</dd>
                            </div>
                        {% endif %}
                        {% if protocol.veterinarian.email %}
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Email</dt>
                                <dd class="mt-1 text-sm text-gray-900">
                                    <a href="mailto:{{ protocol.veterinarian.email }}" class="text-blue-600 hover:text-blue-800">
                                        {{ protocol.veterinarian.email }}
                                    </a>
                                </dd>
                            </div>
                        {% endif %}
                        {% if protocol.veterinarian.address %}
                            <div>
                                <dt class="text-sm font-medium text-gray-500">Dirección</dt>
                                <dd class="mt-1 text-sm text-gray-900">{{ protocol.veterinarian.address.get_full_address }}</dd>
                            </div>
                        {% endif %}
                    </dl>
                </div>

                <!-- Status Timeline Card -->
                <div class="bg-white shadow-md rounded-lg p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 border-b pb-2">Historial de Estado</h2>
                    {% if status_history %}
                        <div class="flow-root">
                            <ul role="list" class="-mb-8">
                                {% for entry in status_history %}
                                    <li>
                                        <div class="relative pb-8">
                                            {% if not forloop.last %}
                                                <span class="absolute top-4 left-4 -ml-px h-full w-0.5 bg-gray-200" aria-hidden="true"></span>
                                            {% endif %}
                                            <div class="relative flex space-x-3">
                                                <div>
                                                    <span class="h-8 w-8 rounded-full flex items-center justify-center ring-8 ring-white
                                                                 {% if entry.status == 'draft' %}bg-gray-400
                                                                 {% elif entry.status == 'submitted' %}bg-yellow-400
                                                                 {% elif entry.status == 'received' %}bg-blue-400
                                                                 {% elif entry.status == 'processing' %}bg-purple-400
                                                                 {% elif entry.status == 'ready' %}bg-green-400
                                                                 {% else %}bg-gray-400{% endif %}">
                                                        <svg class="h-5 w-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                                        </svg>
                                                    </span>
                                                </div>
                                                <div class="min-w-0 flex-1 pt-1.5">
                                                    <div>
                                                        <p class="text-sm font-medium text-gray-900">{{ entry.get_status_display }}</p>
                                                        {% if entry.description %}
                                                            <p class="text-xs text-gray-500">{{ entry.description }}</p>
                                                        {% endif %}
                                                        <p class="text-xs text-gray-400">{{ entry.changed_at|date:"d" }} de {{ entry.changed_at|date:"F" }} de {{ entry.changed_at|date:"Y" }}, {{ entry.changed_at|date:"H:i" }}</p>
                                                        {% if entry.changed_by %}
                                                            <p class="text-xs text-gray-500 mt-1">
                                                                <span class="font-medium">Por:</span> {{ entry.changed_by.get_full_name|default:entry.changed_by.email }}
                                                            </p>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                    {% else %}
                        <!-- No status history - show current status -->
                        <div class="flow-root">
                            <ul role="list" class="-mb-8">
                                <li>
                                    <div class="relative pb-8">
                                        <div class="relative flex space-x-3">
                                            <div>
                                                <span class="h-8 w-8 rounded-full flex items-center justify-center ring-8 ring-white
                                                             {% if protocol.status == 'draft' %}bg-gray-400
                                                             {% elif protocol.status == 'submitted' %}bg-yellow-400
                                                             {% elif protocol.status == 'received' %}bg-blue-400
                                                             {% elif protocol.status == 'processing' %}bg-purple-400
                                                             {% elif protocol.status == 'ready' %}bg-green-400
                                                             {% else %}bg-gray-400{% endif %}">
                                                    <svg class="h-5 w-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                                                        <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                                    </svg>
                                                </span>
                                            </div>
                                            <div class="min-w-0 flex-1 pt-1.5">
                                                <div>
                                                    <p class="text-sm font-medium text-gray-900">{{ protocol.get_status_display }}</p>
                                                    <p class="text-xs text-gray-500">Estado actual</p>
                                                    <p class="text-xs text-gray-400">{{ protocol.created_at|date:"d" }} de {{ protocol.created_at|date:"F" }} de {{ protocol.created_at|date:"Y" }}, {{ protocol.created_at|date:"H:i" }}</p>
                                                    <p class="text-xs text-gray-500 mt-1">
                                                        <span class="font-medium">Por:</span> Sistema
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                            </ul>
                        </div>
                        <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-md">
                            <p class="text-sm text-blue-800">
                                <span class="font-medium">Nota:</span> Este protocolo no tiene historial de cambios de estado registrado. Se muestra el estado actual.
                            </p>
                        </div>
                    {% endif %}
                </div>

                <!-- Actions Card -->
                <div class="bg-white shadow-md rounded-lg p-6">
                    <h2 class="text-lg font-semibold text-gray-900 mb-4 border-b pb-2">Acciones</h2>
                    <div class="space-y-2">
                        <a href="{% url 'protocols:protocol_list' %}" 
                           class="block w-full px-4 py-2 text-center bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200">
                            ← Volver a la Lista
                        </a>
                        {% if protocol.is_deletable %}
                            <form method="post" action="{% url 'protocols:protocol_delete' protocol.pk %}" 
                                  onsubmit="return confirm('¿Está seguro que desea eliminar este protocolo?');">
                                {% csrf_token %}
                                <button type="submit" class="w-full px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                                    Eliminar Protocolo
                                </button>
                            </form>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
